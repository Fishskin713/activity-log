name: Build-Test-Release

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build
        run: |
          npm install
          npm install -g @vercel/ncc
          npm run build
      - uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: dist/

  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: build-artifact

      # 1️⃣ 安裝測試環境
      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Dependencies
        run: |
          echo "📦 Installing dependencies..."
          npm ci
          echo "✅ Dependencies installed."

      # 2️⃣ Pre-commit / Local 階段測試
      - name: Lint & Static Analysis
        run: |
          echo "🧹 Running lint check..."
          npx eslint . || (echo "❌ Linting failed" && exit 1)

      # 3️⃣ Unit Tests
      - name: Run Unit Tests
        run: |
          echo "🧪 Running unit tests..."
          npx jest --ci --coverage || (echo "❌ Unit tests failed" && exit 1)

      # 4️⃣ Integration Tests
      - name: Run Integration Tests
        run: |
          echo "🔗 Running integration tests..."
          npm run test:integration || (echo "❌ Integration tests failed" && exit 1)

      # 5️⃣ End-to-End (E2E) Tests
      - name: Run E2E Tests
        run: |
          echo "🌐 Running end-to-end tests..."
          npx playwright test || (echo "❌ E2E tests failed" && exit 1)

      # 6️⃣ Security & Dependency Scan
      - name: Security Scan
        run: |
          echo "🛡️ Running security scan..."
          npx audit-ci --moderate || (echo "❌ Security vulnerabilities found" && exit 1)

      # 7️⃣ Performance Baseline (簡化版)
      - name: Performance Test
        run: |
          echo "⚙️ Running basic load test..."
          npx autocannon http://localhost:3000 --duration 5 || echo "⚠️ Performance test optional warning"

      # 8️⃣ 結果回饋
      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            coverage/
            test-results/
            reports/

      - name: Notify Test Result
        if: failure()
        run: echo "❌ Some tests failed. Please check test-reports artifact."

      - name: Notify Test Success
        if: success()
        run: echo "✅ All tests passed successfully!"

          
  release:
    runs-on: ubuntu-latest
    needs: test
    environment: dev
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: build-artifact
      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "✅ Tests passed. Releasing new dev build..."
          gh release create "dev-$(date +%s)" dist/* --notes "Automated release after successful tests"
