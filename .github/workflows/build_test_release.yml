name: Build-Test-Release

on:
  push:
    branches: [ master ]
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Build
        run: |
          npm install
          npm install -g @vercel/ncc
          npm run build
      - uses: actions/upload-artifact@v4
        with:
          name: build-artifact
          path: dist/

  test:
    runs-on: ubuntu-latest
    needs: build
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: build-artifact

      # 1ï¸âƒ£ å®‰è£æ¸¬è©¦ç’°å¢ƒ
      - name: Setup Node.js environment
        uses: actions/setup-node@v4
        with:
          node-version: 18

      - name: Install Dependencies
        run: |
          echo "ğŸ“¦ Installing dependencies..."
          npm ci
          echo "âœ… Dependencies installed."

      # 2ï¸âƒ£ Pre-commit / Local éšæ®µæ¸¬è©¦
      - name: Lint & Static Analysis
        run: |
          echo "ğŸ§¹ Running lint check..."
          npx eslint . || (echo "âŒ Linting failed" && exit 1)

      # 3ï¸âƒ£ Unit Tests
      - name: Run Unit Tests
        run: |
          echo "ğŸ§ª Running unit tests..."
          npx jest --ci --coverage || (echo "âŒ Unit tests failed" && exit 1)

      # 4ï¸âƒ£ Integration Tests
      - name: Run Integration Tests
        run: |
          echo "ğŸ”— Running integration tests..."
          npm run test:integration || (echo "âŒ Integration tests failed" && exit 1)

      # 5ï¸âƒ£ End-to-End (E2E) Tests
      - name: Run E2E Tests
        run: |
          echo "ğŸŒ Running end-to-end tests..."
          npx playwright test || (echo "âŒ E2E tests failed" && exit 1)

      # 6ï¸âƒ£ Security & Dependency Scan
      - name: Security Scan
        run: |
          echo "ğŸ›¡ï¸ Running security scan..."
          npx audit-ci --moderate || (echo "âŒ Security vulnerabilities found" && exit 1)

      # 7ï¸âƒ£ Performance Baseline (ç°¡åŒ–ç‰ˆ)
      - name: Performance Test
        run: |
          echo "âš™ï¸ Running basic load test..."
          npx autocannon http://localhost:3000 --duration 5 || echo "âš ï¸ Performance test optional warning"

      # 8ï¸âƒ£ çµæœå›é¥‹
      - name: Upload Test Reports
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-reports
          path: |
            coverage/
            test-results/
            reports/

      - name: Notify Test Result
        if: failure()
        run: echo "âŒ Some tests failed. Please check test-reports artifact."

      - name: Notify Test Success
        if: success()
        run: echo "âœ… All tests passed successfully!"

          
  release:
    runs-on: ubuntu-latest
    needs: test
    environment: dev
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: build-artifact
      - name: Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "âœ… Tests passed. Releasing new dev build..."
          gh release create "dev-$(date +%s)" dist/* --notes "Automated release after successful tests"
